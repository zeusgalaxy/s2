<project name="s2_deploy" default="deploy" basedir="..">
  <tstamp>
    <format property="NOW" pattern="yyyy_MM_dd_hh_mm_ss" />
  </tstamp>

  <property name="s2.remote.basedir" value="/tmp/s2_${NOW}"/>
  <property name="s2.remote.user" value="root"/>
  <property name="s2.remote.password" value="something"/>

  <property environment="env"/>
  <property name="config.file" value="conf/base.conf"/>
  <property name="dist.dir" value="${basedir}/dist"/>
  <property file="${config.file}"/>

  <target name="now">
    <echo>Now is ${NOW}</echo>
    <echo>Now is ${s2.remote.basedir}</echo>
  </target>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <fileset dir="lib/ant">
        <include name="*.jar"/>
      </fileset>
    </classpath>
  </taskdef>

  <target name="compile" >
    <exec executable="play">
      <arg value="-Dconfig.file=${config.file}"/>
      <arg value="compile"/>
    </exec>
  </target>

  <!-- 
    package create the zip to be transferred to the server.
    It sets the 'dist.package.path' property to the fully-qualified path
    to the dist zip file -->
  <target name="package" depends="compile">
    <exec executable="play" outputproperty="raw.dist.package.path"
        failonerror="true">
      <arg value="-Dconfig.file=${config.file}"/>
      <arg value="dist"/>
    </exec>
    <propertyregex 
        property="dist.package.path"
        input="${raw.dist.package.path}"
        regexp="Your application is ready in (.*)"
        select="\1"
        casesensitive="false" />
  </target>

  <macrodef name="copy_dist">
    <attribute name="dist_file"/>
    <attribute name="to_dir"/>
    <attribute name="remote_server"/>
    <attribute name="remote_user"/>
    <sequential>
      <scp 
          trust="true"
          localFile="@{local_dist_file}" 
          todir="@{remote_user}@@{remote_server}:@{to_dir}"/>
    </sequential>
  </macrodef>

  <target name="deploy_single" depends="package" >
    <!--
    scp dist/s2-1.0.19.zip root@qa-app-titan:s2-1.0.19.zip   
    Back on target machine:
      unzip s2-1.0.19.zip
    cd s2-1.0.16
    chmod a+x ./start
    nohup ./start &

    -->
    <copy_dist 
        dist_file="${dist.package.path}"
        to_dir="${s2.remote.basedir}"
        remote_server="${server}"
        remote_user="${s2.remote.server}"/>
    <!-- FIXME: add the rest -->
  </target>

  <target name="deploy" depends="package" >
    <foreach 
        list="${application.server_list}" 
        delimiter="," 
        parallel="true"
        param="server" 
        target="deploy_single"/>
  </target>
</project>
